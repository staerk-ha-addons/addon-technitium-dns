#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Watch Let's Encrypt certificates for changes and regenerate PKCS #12 if needed
# ==============================================================================

source /etc/s6-overlay/scripts/cert_utils.sh

bashio::log.info "Starting certificate watch using inotify..."

while true; do
    inotifywait -e close_write,move,create "$CERT_SOURCE_CHAIN" "$CERT_SOURCE_KEY" >/dev/null 2>&1
    bashio::log.info "Detected certificate change â€” checking and regenerating if needed..."
    check_and_generate
done

if check_and_generate; then
    bashio::log.info "Restarting Technitium DNS Server to load new certificate..."
    s6-svc -r /run/s6-rc/supervise/dns-server
fi
